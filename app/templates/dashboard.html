{% extends "base.html" %}
{% block title %}Calendar · Daily Manna Email{% endblock %}
{% block content %}
<section id="flash-messages" class="flash-messages">
  {% if message %}
    <div class="flash success" data-type="success">{{ message }}</div>
  {% endif %}
  {% if error %}
    <div class="flash error" data-type="error">{{ error }}</div>
    {% if request.query_params.get('action') == 'manage_permissions' %}
      <div class="flash info" data-type="info">
        <a href="https://myaccount.google.com/permissions" target="_blank" class="manage-permissions-link">
          Manage Google Account Permissions →
        </a>
      </div>
    {% endif %}
  {% endif %}
</section>
<section class="summary">
  <p>Schedule file: <code>{{ schedule_path }}</code></p>
</section>
<section id="oauth-section" class="oauth-status">
  <h3>Email Authorization</h3>
  <div id="oauth-status">
    <p class="oauth-loading">Checking authorization status...</p>
  </div>
</section>
<section id="email-activity-section" class="email-activity">
  <h3>Email Activity</h3>
  <div id="email-activity-content">
    <div class="activity-loading">
      <p>Loading recent job activity...</p>
    </div>
  </div>
</section>
<section class="calendar-shell">
  <header class="calendar-toolbar">
    <div class="calendar-toolbar-info">
      <h2 id="month-year" class="calendar-range">Loading...</h2>
      <p class="calendar-help-text">Shift-click to multi-select, drag selections to move, or press <kbd>Shift</kbd>+<kbd>D</kbd> to jump to a specific date.</p>
      <div class="calendar-toolbar-batch" id="batch-toolbar" hidden>
        <button type="button" id="batch-edit-btn" class="primary">Edit All</button>
        <span id="selection-count"></span>
      </div>
    </div>
    <div class="calendar-toolbar-controls">
      <form method="post" action="/logout" style="display: inline;">
        <button type="submit" class="logout-btn" aria-label="Logout">Logout</button>
      </form>
      <button type="button" id="prev-month" aria-label="Previous month">‹</button>
      <button type="button" id="today-month">Today</button>
      <button type="button" id="next-month" aria-label="Next month">›</button>
    </div>
  </header>
  <div id="calendar-scroll" class="calendar-scroll" aria-live="polite"></div>
</section>
<div id="calendar-popover" class="calendar-popover" hidden role="dialog" aria-modal="true" aria-labelledby="popover-date-label">
  <form id="popover-form">
    <header class="popover-header">
      <div>
        <p class="popover-date" id="popover-date-label"></p>
        <p class="popover-meta" id="popover-sent-meta"></p>
      </div>
      <button type="button" class="popover-close" data-action="close" aria-label="Close popover">×</button>
    </header>
    <input type="hidden" name="date" id="popover-date" value="">
    <div class="popover-field">
      <label for="popover-selector">Selector</label>
      <input type="text" id="popover-selector" name="selector" placeholder="e.g. 2-1-3" required>
    </div>
    <div class="popover-field">
      <label for="popover-status">Status</label>
      <select id="popover-status" name="status">
        <option value="">-- Select status --</option>
        <option value="pending">Pending</option>
        <option value="sent">Sent</option>
        <option value="skipped">Skipped</option>
      </select>
    </div>
    <div class="popover-field">
      <label for="popover-notes">Notes</label>
      <textarea id="popover-notes" name="notes" rows="3" placeholder="Add context"></textarea>
    </div>
    <div class="popover-field">
      <label for="popover-override">Override descriptor</label>
      <input type="text" id="popover-override" name="override" placeholder="Optional override">
    </div>
    <div class="popover-actions">
      <div class="popover-action-group">
        <button type="submit" class="primary">Save</button>
        <button type="button" data-action="mark-sent">Mark sent</button>
        <button type="button" data-action="mark-skipped">Mark skipped</button>
        <button type="button" data-action="delete" class="danger">Delete</button>
      </div>
      <button type="button" data-action="close">Cancel</button>
    </div>
  </form>
</div>
<div id="date-adjust-overlay" class="calendar-move-overlay" hidden>
  <form id="date-adjust-form" class="calendar-move-card">
    <p>Move selected events to:</p>
    <input type="date" id="date-adjust-input" required>
    <div class="overlay-actions">
      <button type="submit" class="primary">Apply</button>
      <button type="button" data-action="cancel">Cancel</button>
    </div>
  </form>
</div>
<div id="batch-edit-overlay" class="calendar-edit-overlay" hidden>
  <form id="batch-edit-form" class="calendar-edit-card">
    <p>Edit selected events:</p>
    <div class="batch-edit-field">
      <label for="batch-selector">Selector</label>
      <input type="text" id="batch-selector" name="selector" placeholder="e.g. 2-1-3" aria-describedby="batch-selector-help batch-range-hint">
      <small id="batch-selector-help" class="form-text text-muted">
        <!-- Dynamic help text from backend -->
      </small>
      <small id="batch-range-hint" class="form-text text-info" hidden>
        <!-- Dynamic range hint from backend -->
      </small>
      <small>Leave blank to keep existing values</small>
    </div>
    <div class="batch-edit-field">
      <label for="batch-status">Status</label>
      <select id="batch-status" name="status">
        <option value="">-- Keep existing --</option>
        <option value="pending">Pending</option>
        <option value="sent">Sent</option>
        <option value="skipped">Skipped</option>
      </select>
    </div>
    <div class="batch-edit-field">
      <label for="batch-notes">Notes</label>
      <textarea id="batch-notes" name="notes" rows="3" placeholder="Add context"></textarea>
      <small>Leave blank to keep existing values</small>
    </div>
    <div class="batch-edit-field">
      <label for="batch-override">Override descriptor</label>
      <input type="text" id="batch-override" name="override" placeholder="Optional override">
      <small>Leave blank to keep existing values</small>
    </div>
    <div class="overlay-actions">
      <div class="overlay-action-group">
        <button type="submit" class="primary">Apply to All</button>
        <button type="button" data-action="batch-delete" class="danger">Delete Events</button>
      </div>
      <button type="button" data-action="cancel">Cancel</button>
    </div>
  </form>
</div>
<script>
  window.CalendarConfig = {
    schedulePath: "{{ schedule_path }}",
    message: null,
    error: null
  };

  // OAuth status management
  async function checkOAuthStatus() {
    const statusDiv = document.getElementById('oauth-status');
    try {
      const response = await fetch('/oauth/status');
      if (!response.ok) {
        throw new Error('Failed to check OAuth status');
      }
      const data = await response.json();

      // Debug logging for OAuth status (remove in production)
      // console.log('OAuth status response:', data);

      if (data.authorized && data.scope_status === 'exact') {
        statusDiv.innerHTML = `
          <p class="oauth-authorized">
            ✓ You have authorized the app to use your email
          </p>
        `;
      } else if (data.authorized && data.scope_status === 'over-authorized') {
        const extraScopesDescriptions = data.extra_scopes_descriptions || [];
        statusDiv.innerHTML = `
          <div class="oauth-over-authorized">
            <p>✓ Authorized with additional permissions</p>
            <p style="font-size: 0.9em; color: #6b7280; margin: 0.5rem 0;">
              Additional permissions: ${extraScopesDescriptions.join(', ')}
            </p>
            <p style="font-size: 0.9em; color: #6b7280; margin: 0.5rem 0 1rem;">
              To use only required permissions, revoke and re-authorize.
            </p>
            <a href="https://myaccount.google.com/permissions" target="_blank" class="oauth-manage-btn">
              Manage Google Account Permissions
            </a>
          </div>
        `;
      } else if (data.scope_status === 'under-authorized' || (data.missing_scopes && data.missing_scopes.length > 0)) {
        // Token exists but missing required scopes
        const missingScopesDescriptions = data.missing_scopes_descriptions || [];
        const missingList = missingScopesDescriptions.length > 0 ? ` (${missingScopesDescriptions.join(', ')})` : '';
        statusDiv.innerHTML = `
          <div class="oauth-under-authorized">
            <p>❌ Email authorization incomplete - missing required permissions${missingList}</p>
            <a href="/oauth/start" class="oauth-grant-btn">Grant Required Access</a>
          </div>
        `;
      } else {
        // No token at all or other unauthorized states
        statusDiv.innerHTML = `
          <div class="oauth-unauthorized">
            <p>Email authorization required to send emails</p>
            <a href="/oauth/start" class="oauth-grant-btn">Grant Email Access</a>
          </div>
        `;
      }
    } catch (error) {
      console.error('OAuth status check failed:', error);
      statusDiv.innerHTML = `
        <div class="oauth-unauthorized">
          <p>Unable to check authorization status</p>
          <a href="/oauth/start" class="oauth-grant-btn">Grant Email Access</a>
        </div>
      `;
    }
  }

  // Check OAuth status when page loads
  document.addEventListener('DOMContentLoaded', function() {
    checkOAuthStatus();
    loadEmailActivity();
  });

  // Email Activity management
  async function loadEmailActivity() {
    const activityDiv = document.getElementById('email-activity-content');
    try {
      const response = await fetch('/api/jobs/recent?limit=10');
      if (!response.ok) {
        throw new Error('Failed to load job activity');
      }
      const data = await response.json();

      if (data.executions && data.executions.length > 0) {
        activityDiv.innerHTML = generateActivityHTML(data.executions);
      } else {
        activityDiv.innerHTML = `
          <div class="activity-empty">
            <p>No recent job activity found.</p>
            <p>Jobs will appear here once they run automatically or are triggered manually.</p>
          </div>
        `;
      }
    } catch (error) {
      console.error('Email activity load failed:', error);
      activityDiv.innerHTML = `
        <div class="activity-error">
          <p>Unable to load email activity.</p>
        </div>
      `;
    }
  }

  function generateActivityHTML(executions) {
    let html = '<div class="activity-list">';

    executions.forEach(execution => {
      const statusClass = getStatusClass(execution.status);
      const statusIcon = getStatusIcon(execution.status);
      const duration = execution.duration_formatted || 'Running...';
      const hasJsonOutput = execution.json_output && Object.keys(execution.json_output).length > 0;

      html += `
        <div class="activity-item ${statusClass}">
          <div class="activity-header">
            <div class="activity-title">
              <span class="activity-status-icon">${statusIcon}</span>
              <span class="activity-name">${formatJobName(execution.job_name)}</span>
              <span class="activity-time">${formatTime(execution.start_time)}</span>
            </div>
            <div class="activity-meta">
              <span class="activity-duration">${duration}</span>
              ${execution.retry_count > 0 ? `<span class="activity-retries">Retry ${execution.retry_count}</span>` : ''}
            </div>
          </div>
          <div class="activity-details">
            ${hasJsonOutput ? generateJsonOutput(execution.json_output) : ''}
            ${execution.error_message ? `<div class="activity-error-msg">${execution.error_message}</div>` : ''}
          </div>
          <div class="activity-actions">
            <button class="activity-logs-btn" onclick="showRawLogs('${execution.job_name}_${execution.start_time}')">
              View Raw Logs
            </button>
          </div>
        </div>
      `;
    });

    html += '</div>';
    return html;
  }

  function generateJsonOutput(jsonOutput) {
    let html = '<div class="activity-json">';
    if (jsonOutput.date) {
      html += `<div class="json-field"><strong>Date:</strong> ${jsonOutput.date}</div>`;
    }
    if (jsonOutput.selector) {
      html += `<div class="json-field"><strong>Selector:</strong> ${jsonOutput.selector}</div>`;
    }
    if (jsonOutput.weekday) {
      html += `<div class="json-field"><strong>Weekday:</strong> ${jsonOutput.weekday}</div>`;
    }
    if (jsonOutput.content_source) {
      html += `<div class="json-field"><strong>Source:</strong> ${jsonOutput.content_source}</div>`;
    }
    if (jsonOutput.resend) {
      html += `<div class="json-field"><strong>Resend:</strong> Yes</div>`;
    }
    html += '</div>';
    return html;
  }

  function formatJobName(jobName) {
    const nameMap = {
      'daily_email_send': 'Daily Email Send',
      'weekly_schedule_summary': 'Weekly Schedule Summary'
    };
    return nameMap[jobName] || jobName;
  }

  function formatTime(isoString) {
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;

    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours}h ago`;

    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays}d ago`;
  }

  function getStatusClass(status) {
    switch (status) {
      case 'success': return 'status-success';
      case 'failed': return 'status-failed';
      case 'running': return 'status-running';
      case 'skipped': return 'status-skipped';
      default: return 'status-unknown';
    }
  }

  function getStatusIcon(status) {
    switch (status) {
      case 'success': return '✓';
      case 'failed': return '✗';
      case 'running': return '⟳';
      case 'skipped': return '⊘';
      default: return '?';
    }
  }

  async function showRawLogs(executionId) {
    try {
      const response = await fetch(`/api/jobs/logs/${executionId}`);
      if (!response.ok) {
        throw new Error('Failed to load logs');
      }
      const data = await response.json();

      // Create modal overlay
      const modal = document.createElement('div');
      modal.className = 'logs-modal-overlay';
      modal.innerHTML = `
        <div class="logs-modal">
          <div class="logs-modal-header">
            <h3>Raw Logs: ${formatJobName(data.execution.job_name)}</h3>
            <button class="logs-modal-close" onclick="this.closest('.logs-modal-overlay').remove()">×</button>
          </div>
          <div class="logs-modal-content">
            <pre class="logs-content">${data.logs.map(line => escapeHtml(line)).join('\n')}</pre>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Close on backdrop click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });

    } catch (error) {
      console.error('Failed to load logs:', error);
      alert('Failed to load logs. Check console for details.');
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
<script src="/static/calendar.js" defer></script>
{% endblock %}
