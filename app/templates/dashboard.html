{% extends "base.html" %}
{% block title %}Calendar · Daily Manna Email{% endblock %}
{% block header_right %}
  <div class="header-actions">
    <button type="button" id="caffeine-indicator" class="caffeine-icon" aria-label="Caffeine mode">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 200 161.458" fill="currentColor" class="caffeine-svg">
        <g transform="translate(-15.064 -266.634)">
          <path d="M22.791,266.634V368.21a26.277,26.277,0,0,0,26.335,26.335H145.06A26.278,26.278,0,0,0,171.4,368.21V352.6c15.908,2.54,32.609-7.022,39.985-22.893,8.585-18.479,1.651-39-15.487-45.836a31.7,31.7,0,0,0-12.3-2.213,35.674,35.674,0,0,0-12.195,2.467V266.635Zm158.876,36.122h0a12.955,12.955,0,0,1,5.025.9c7,2.793,9.833,11.176,6.326,18.725S181,333.791,173.994,331a12.172,12.172,0,0,1-2.6-1.437V307.119a15.513,15.513,0,0,1,10.272-4.363Zm-9.392,105.236-.2,0H25.544a10.052,10.052,0,1,0,0,20.085H172.076a10.052,10.052,0,1,0,.2-20.09Z" transform="translate(0 0)"/>
        </g>
      </svg>
    </button>
    <button type="button" id="dispatch-gear" class="gear-icon" aria-label="Dispatch settings">
      <svg viewBox="0 0 24 24" fill="currentColor" class="gear-svg">
        <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96c-.5-.38-1.04-.7-1.64-.94l-.36-2.54a.5.5 0 0 0-.5-.42h-3.84a.5.5 0 0 0-.5.42l-.36 2.54c-.6.24-1.14.56-1.64.94l-2.39-.96a.5.5 0 0 0-.6.22L2.7 8.84a.5.5 0 0 0 .12.64l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.5.5 0 0 0-.12.64l1.92 3.32a.5.5 0 0 0 .6.22l2.39-.96c.5.38 1.04.7 1.64.94l.36 2.54a.5.5 0 0 0 .5.42h3.84a.5.5 0 0 0 .5-.42l.36-2.54c.6-.24 1.14-.56 1.64-.94l2.39.96a.5.5 0 0 0 .6-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58ZM12 15.6a3.6 3.6 0 1 1 0-7.2 3.6 3.6 0 0 1 0 7.2Z"/>
      </svg>
    </button>
    <button type="button" id="notification-bell" class="bell-icon" aria-label="Notifications">
      <svg viewBox="0 0 24 24" fill="currentColor" class="bell-svg">
        <path d="M12 2C10.896 2 10 2.896 10 4v1.07C7.835 5.732 6 7.814 6 10v6H4v2h16v-2h-2v-6c0-2.186-1.835-4.268-4-4.93V4c0-1.104-.896-2-2-2zM12 22c1.104 0 2-.896 2-2H10c0 1.104.896 2 2 2z"/>
      </svg>
      <span id="notification-dot" class="notification-dot" style="display: none;"></span>
    </button>
  </div>
{% endblock %}
{% block content %}
<section id="flash-messages" class="flash-messages">
  {% if message %}
    <div class="flash success" data-type="success">{{ message }}</div>
  {% endif %}
  {% if error %}
    <div class="flash error" data-type="error">{{ error }}</div>
    {% if request.query_params.get('action') == 'manage_permissions' %}
      <div class="flash info" data-type="info">
        <a href="https://myaccount.google.com/permissions" target="_blank" class="manage-permissions-link">
          Manage Google Account Permissions →
        </a>
      </div>
    {% endif %}
  {% endif %}
</section>
<section class="summary">
  <p>Schedule file: <code>{{ schedule_path }}</code></p>
</section>
<section id="oauth-section" class="oauth-status">
  <h3>Email Authorization</h3>
  <div id="oauth-status">
    <p class="oauth-loading">Checking authorization status...</p>
  </div>
</section>

<section class="calendar-shell">
  <header class="calendar-toolbar">
    <div class="calendar-toolbar-info">
      <h2 id="month-year" class="calendar-range">Loading...</h2>
      <p class="calendar-help-text">Shift-click to multi-select, drag selections to move, or press <kbd>Shift</kbd>+<kbd>D</kbd> to jump to a specific date.</p>
      <div class="calendar-toolbar-batch" id="batch-toolbar" hidden>
        <button type="button" id="batch-edit-btn" class="primary">Edit All</button>
        <span id="selection-count"></span>
      </div>
    </div>
    <div class="calendar-toolbar-controls">
      <form method="post" action="/logout" style="display: inline;">
        <button type="submit" class="logout-btn" aria-label="Logout">Logout</button>
      </form>
      <button type="button" id="prev-month" aria-label="Previous month">‹</button>
      <button type="button" id="today-month">Today</button>
      <button type="button" id="next-month" aria-label="Next month">›</button>
    </div>
  </header>
  <div id="calendar-scroll" class="calendar-scroll" aria-live="polite"></div>
</section>
<div id="calendar-popover" class="calendar-popover overlay" hidden role="dialog" aria-modal="true" aria-labelledby="popover-date-label">
  <form id="popover-form">
    <header class="popover-header">
      <div>
        <p class="popover-date" id="popover-date-label"></p>
        <p class="popover-meta" id="popover-sent-meta"></p>
      </div>
      <button type="button" class="popover-close" data-action="close" aria-label="Close popover">×</button>
    </header>
    <input type="hidden" name="date" id="popover-date" value="">
    <div class="popover-field">
      <label for="popover-selector">Selector</label>
      <input type="text" id="popover-selector" name="selector" placeholder="e.g. 2-1-3" required>
    </div>
    <div class="popover-field">
      <label for="popover-status">Status</label>
      <select id="popover-status" name="status">
        <option value="">-- Select status --</option>
        <option value="pending">Pending</option>
        <option value="sent">Sent</option>
        <option value="skipped">Skipped</option>
      </select>
    </div>
    <div class="popover-field">
      <label for="popover-notes">Notes</label>
      <textarea id="popover-notes" name="notes" rows="3" placeholder="Add context"></textarea>
    </div>
    <div class="popover-field">
      <label for="popover-override">Override descriptor</label>
      <input type="text" id="popover-override" name="override" placeholder="Optional override">
    </div>
    <div class="popover-actions">
      <div class="popover-action-group">
        <button type="submit" class="primary">Save</button>
        <button type="button" data-action="mark-sent">Mark sent</button>
        <button type="button" data-action="mark-skipped">Mark skipped</button>
        <button type="button" data-action="delete" class="danger">Delete</button>
      </div>
      <button type="button" data-action="close">Cancel</button>
    </div>
  </form>
</div>
<div id="date-adjust-overlay" class="calendar-move-overlay overlay" hidden>
  <form id="date-adjust-form" class="calendar-move-card">
    <p>Move selected events to:</p>
    <input type="date" id="date-adjust-input" required>
    <div class="overlay-actions">
      <button type="submit" class="primary">Apply</button>
      <button type="button" data-action="cancel">Cancel</button>
    </div>
  </form>
</div>
<div id="batch-edit-overlay" class="calendar-edit-overlay overlay" hidden>
  <form id="batch-edit-form" class="calendar-edit-card">
    <p>Edit selected events:</p>
    <div class="batch-edit-field">
      <label for="batch-selector">Selector</label>
      <input type="text" id="batch-selector" name="selector" placeholder="e.g. 2-1-3" aria-describedby="batch-selector-help batch-range-hint">
      <small id="batch-selector-help" class="form-text text-muted">
        <!-- Dynamic help text from backend -->
      </small>
      <small id="batch-range-hint" class="form-text text-info" hidden>
        <!-- Dynamic range hint from backend -->
      </small>
      <small>Leave blank to keep existing values</small>
    </div>
    <div class="batch-edit-field">
      <label for="batch-status">Status</label>
      <select id="batch-status" name="status">
        <option value="">-- Keep existing --</option>
        <option value="pending">Pending</option>
        <option value="sent">Sent</option>
        <option value="skipped">Skipped</option>
      </select>
    </div>
    <div class="batch-edit-field">
      <label for="batch-notes">Notes</label>
      <textarea id="batch-notes" name="notes" rows="3" placeholder="Add context"></textarea>
      <small>Leave blank to keep existing values</small>
    </div>
    <div class="batch-edit-field">
      <label for="batch-override">Override descriptor</label>
      <input type="text" id="batch-override" name="override" placeholder="Optional override">
      <small>Leave blank to keep existing values</small>
    </div>
    <div class="overlay-actions">
      <div class="overlay-action-group">
        <button type="submit" class="primary">Apply to All</button>
        <button type="button" data-action="batch-delete" class="danger">Delete Events</button>
      </div>
      <button type="button" data-action="cancel">Cancel</button>
    </div>
  </form>
</div>
<div id="notification-overlay" class="notification-overlay overlay" hidden>
  <div class="notification-center">
    <div class="notification-header">
      <h3>Notifications</h3>
      <div class="notification-header-actions">
        <button type="button" class="notification-refresh" aria-label="Refresh notifications">↻</button>
        <button class="notification-close" aria-label="Close">×</button>
      </div>
    </div>
    <div class="notification-filters">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="unresolved">Unresolved</button>
    </div>
    <div id="notification-list" class="notification-list">
      <!-- notifications will be loaded here -->
      <div id="notification-pagination-footer" class="notification-pagination-footer">
        <div id="notification-load-more-item" class="notification-load-more-item" hidden>
          <button id="load-more-btn" class="load-more-btn" type="button">Load More</button>
        </div>
        <div id="notification-loading-item" class="notification-loading-item" hidden>
          <div class="loading-spinner"></div>
          <span>Loading more notifications...</span>
        </div>
        <div id="notification-no-more-item" class="notification-no-more-item" hidden>
          <span>No more notifications</span>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="caffeine-overlay" class="caffeine-overlay overlay" hidden role="dialog" aria-modal="true" aria-labelledby="caffeine-title">
  <div class="caffeine-center">
    <div class="caffeine-header">
      <div>
        <h3 id="caffeine-title">Caffeine Mode</h3>
        <p class="caffeine-header-subtitle">Prevents the server from going to sleep.</p>
      </div>
      <button class="caffeine-close" aria-label="Close">×</button>
    </div>
    <div class="caffeine-content">
      <div class="caffeine-info">
        <p><strong>What is Caffeine Mode?</strong></p>
        <p>Caffeine mode is a feature that prevents the server from entering sleep mode by periodically pinging itself every 10 minutes. This ensures the application remains responsive and available for scheduled jobs.</p>
      </div>
      <div class="caffeine-status-section">
        <p><strong>Current Status:</strong></p>
        <div id="caffeine-mode-status" class="caffeine-mode-status">Loading...</div>
      </div>
      <div class="caffeine-details">
        <p><strong>How it works:</strong></p>
        <ul>
          <li>The server pings itself every 10 minutes</li>
          <li>This keeps the server awake and responsive</li>
          <li>Ensures scheduled jobs run on time</li>
          <li>Runs in the background without affecting performance</li>
        </ul>
      </div>
      <div class="caffeine-actions">
        <button id="caffeine-refresh-btn" class="caffeine-refresh-btn" type="button">Check Status</button>
      </div>
    </div>
  </div>
</div>
<div id="dispatch-overlay" class="dispatch-overlay overlay" hidden>
  <div class="dispatch-center">
    <div class="dispatch-header">
      <div>
        <h3>Dispatch Rules</h3>
        <p class="dispatch-header-subtitle">Adjust job times in Asia/Taipei.</p>
        <span class="dispatch-header-meta">Config: <code id="dispatch-config-path">Loading...</code></span>
      </div>
      <div class="dispatch-header-actions">
        <button type="button" class="dispatch-refresh" aria-label="Refresh dispatch rules">↻</button>
        <button class="dispatch-close" aria-label="Close">×</button>
      </div>
    </div>
    <div id="dispatch-rules-list" class="dispatch-rules-list">
      <div class="dispatch-rules-loading">Loading dispatch rules...</div>
    </div>
    <div id="dispatch-rules-feedback" class="dispatch-rules-feedback" role="status" aria-live="polite"></div>
  </div>
</div>
<script defer src="/static/dispatch_rules.js"></script>
<script defer src="/static/caffeine_mode.js"></script>
<script>
  window.CalendarConfig = {
    schedulePath: "{{ schedule_path }}",
    message: null,
    error: null
  };

  // OAuth status management
  async function checkOAuthStatus() {
    const statusDiv = document.getElementById('oauth-status');
    try {
      const response = await fetch('/oauth/status');
      if (!response.ok) {
        throw new Error('Failed to check OAuth status');
      }
      const data = await response.json();

      // Debug logging for OAuth status (remove in production)
      // console.log('OAuth status response:', data);

      if (data.authorized && data.scope_status === 'exact') {
        statusDiv.innerHTML = `
          <p class="oauth-authorized">
            ✓ You have authorized the app to use your email
          </p>
          <p style="font-size: 0.9em; color: #6b7280; margin: 1rem 0 0;">
            Email sending and schedule reply features are available
          </p>
        `;
      } else if (data.authorized && data.scope_status === 'over-authorized') {
        const extraScopesDescriptions = data.extra_scopes_descriptions || [];
        statusDiv.innerHTML = `
          <div class="oauth-over-authorized">
            <p>✓ Authorized with additional permissions</p>
            <p style="font-size: 0.9em; color: #6b7280; margin: 1rem 0 0;">
              Email sending and schedule reply features are available
            </p>
            <p style="font-size: 0.9em; color: #6b7280; margin: 0.5rem 0;">
              Additional permissions: ${extraScopesDescriptions.join(', ')}
            </p>
            <p style="font-size: 0.9em; color: #6b7280; margin: 0.5rem 0 1rem;">
              To use only required permissions, revoke and re-authorize.
            </p>
            <a href="https://myaccount.google.com/permissions" target="_blank" class="oauth-manage-btn">
              Manage Google Account Permissions
            </a>
          </div>
        `;
      } else if (data.authorized && data.scope_status === 'partial') {
        // Partial permissions - show available and disabled features
        const availableFeatures = data.available_features || [];
        const disabledFeatures = data.disabled_features || [];
        const missingScopesDescriptions = data.missing_scopes_descriptions || [];

        let featuresHtml = '';
        if (availableFeatures.length > 0) {
          featuresHtml += `<p style="font-size: 0.9em; color: #059669; margin: 0.5rem 0;">✓ Available: ${availableFeatures.join(', ')}</p>`;
        }
        if (disabledFeatures.length > 0) {
          featuresHtml += `<p style="font-size: 0.9em; color: #dc2626; margin: 0.5rem 0;">✗ Disabled: ${disabledFeatures.join(', ')}</p>`;
        }
        if (missingScopesDescriptions.length > 0) {
          featuresHtml += `<p style="font-size: 0.9em; color: #6b7280; margin: 0.5rem 0;">Missing permissions: ${missingScopesDescriptions.join(', ')}</p>`;
        }

        statusDiv.innerHTML = `
          <div class="oauth-partial">
            <p>⚠️ Partial email authorization</p>
            ${featuresHtml}
            <p style="font-size: 0.9em; color: #6b7280; margin: 0.5rem 0 1rem;">
              Some features are disabled due to limited permissions. You can grant full access for all features.
            </p>
            <a href="/oauth/start" class="oauth-grant-btn">Grant Full Access</a>
            <a href="https://myaccount.google.com/permissions" target="_blank" class="oauth-manage-btn" style="margin-left: 0.5rem;">
              Manage Permissions
            </a>
          </div>
        `;
      } else {
        // No token at all or other unauthorized states
        statusDiv.innerHTML = `
          <div class="oauth-unauthorized">
            <p>Email authorization required to send emails</p>
            <a href="/oauth/start" class="oauth-grant-btn">Grant Email Access</a>
          </div>
        `;
      }
    } catch (error) {
      console.error('OAuth status check failed:', error);
      statusDiv.innerHTML = `
        <div class="oauth-unauthorized">
          <p>Unable to check authorization status</p>
          <a href="/oauth/start" class="oauth-grant-btn">Grant Email Access</a>
        </div>
      `;
    }
  }

  // Notification system state
  let currentNotifications = [];
  let acknowledgedNotifications = new Set(JSON.parse(localStorage.getItem('acknowledged_notifications') || '[]'));
  let notificationPagination = {
    offset: 0,
    limit: 20,
    hasMore: true,
    isLoading: false
  };

  const NOTIFICATION_REFRESH_INTERVAL_MS = 30000;
  let notificationRefreshTimer = null;

  const startNotificationPolling = () => {
    if (notificationRefreshTimer) {
      clearInterval(notificationRefreshTimer);
    }
    notificationRefreshTimer = setInterval(() => {
      const overlay = document.getElementById('notification-overlay');
      if (!overlay.hidden) {
        loadNotifications();
      }
    }, NOTIFICATION_REFRESH_INTERVAL_MS);
  };

  const stopNotificationPolling = () => {
    if (notificationRefreshTimer) {
      clearInterval(notificationRefreshTimer);
      notificationRefreshTimer = null;
    }
  };

  // Check OAuth status when page loads
  document.addEventListener('DOMContentLoaded', function() {
    checkOAuthStatus();
    loadNotifications();

    // Bell icon click
    document.getElementById('notification-bell').addEventListener('click', toggleNotificationOverlay);

    // Close overlay
    document.querySelector('.notification-close').addEventListener('click', hideNotificationOverlay);

    // Refresh button
    const refreshBtn = document.querySelector('.notification-refresh');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', function() {
        loadNotifications();
      });
    }

    // Click outside to close
    document.addEventListener('click', function(e) {
      const overlay = document.getElementById('notification-overlay');
      const bell = document.getElementById('notification-bell');

      if (!overlay.hidden) {
        const center = overlay.querySelector('.notification-center');
        const isClickInsideOverlay = center.contains(e.target) || bell.contains(e.target);
        const isClickInsideModal = document.querySelector('.job-details-modal-overlay')?.contains(e.target);

        if (!isClickInsideOverlay && !isClickInsideModal) {
          hideNotificationOverlay();
        }
      }
    });

    // Filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        resetPagination();
        loadNotifications(); // Reload notifications instead of just re-rendering to ensure offset is correct
      });
    });

    // Load More button
    document.getElementById('load-more-btn').addEventListener('click', loadMoreNotifications);
  });

  function showNotificationOverlay() {
    // Hide all other overlays before showing this one
    if (window.hideAllOverlaysExcept) {
      window.hideAllOverlaysExcept('notification-overlay');
    } else {
      // Fallback to manual hiding if centralized function not available
      const otherOverlays = ['calendar-popover', 'date-adjust-overlay', 'batch-edit-overlay', 'dispatch-overlay'];
      otherOverlays.forEach(id => {
        const overlay = document.getElementById(id);
        if (overlay && !overlay.hidden) {
          overlay.hidden = true;
        }
      });
    }

    const overlay = document.getElementById('notification-overlay');
    const bell = document.getElementById('notification-bell');
    const rect = bell.getBoundingClientRect();

    // Show off-screen to measure width
    overlay.style.top = '-1000px';
    overlay.hidden = false;

    const center = overlay.querySelector('.notification-center');
    const panelWidth = center.offsetWidth;

    // Now position correctly under bell's bottom-right
    overlay.style.top = (rect.bottom + 8) + 'px';
    overlay.style.left = (rect.right - panelWidth) + 'px';
  }

  function toggleNotificationOverlay() {
    const overlay = document.getElementById('notification-overlay');
    if (overlay.hidden) {
      showNotificationOverlay();
      loadNotifications();
      startNotificationPolling();
    } else {
      hideNotificationOverlay();
      stopNotificationPolling();
    }
  }

  function hideNotificationOverlay() {
    document.getElementById('notification-overlay').hidden = true;
    stopNotificationPolling();
  }

  // Expose hide function for centralized overlay management
  window.hideNotificationOverlay = hideNotificationOverlay;

  // Notification management
  async function loadNotifications() {
    try {
      const response = await fetch('/api/jobs/recent?limit=20');
      if (!response.ok) {
        throw new Error('Failed to load notifications');
      }
      const data = await response.json();
      currentNotifications = data.executions || [];
      // Reset pagination state for initial load
      notificationPagination.offset = currentNotifications.length;
      notificationPagination.hasMore = data.pagination?.has_more || false;
      renderNotifications();
      updateBellDot();
      // Ensure loading state is properly hidden after initial load
      hideLoadingState();
    } catch (error) {
      console.error('Notification load failed:', error);
    }
  }

  async function loadMoreNotifications() {
    // Prevent multiple concurrent calls
    if (notificationPagination.isLoading || !notificationPagination.hasMore) {
      return;
    }

    // Disable button immediately and show loading state
    const loadMoreBtn = document.getElementById('load-more-btn');
    loadMoreBtn.disabled = true;
    notificationPagination.isLoading = true;
    showLoadingState();

    const MAX_FETCH_PAGES = 5;
    let pagesFetched = 0;
    let notificationsFound = false;

    try {
      while (!notificationsFound && notificationPagination.hasMore && pagesFetched < MAX_FETCH_PAGES) {
        const response = await fetch(`/api/jobs/recent?limit=${notificationPagination.limit}&offset=${notificationPagination.offset}`);
        if (!response.ok) {
          throw new Error('Failed to load more notifications');
        }
        const data = await response.json();
        
        const newNotifications = data.executions || [];
        if (newNotifications.length > 0) {
          notificationPagination.offset += newNotifications.length;
          notificationPagination.hasMore = data.pagination?.has_more || false;
          
          // Filter for unseen notifications if in unresolved tab
          const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
          if (activeFilter === 'unresolved') {
            const unseenNotifications = newNotifications.filter(n => 
              n.status === 'failed' && !acknowledgedNotifications.has(`${n.job_name}_${n.start_time}`)
            );
            
            if (unseenNotifications.length > 0) {
              currentNotifications = [...currentNotifications, ...newNotifications];
              notificationsFound = true;
            }
          } else {
            // For all tab, add all notifications
            currentNotifications = [...currentNotifications, ...newNotifications];
            notificationsFound = true;
          }
        } else {
          notificationPagination.hasMore = false;
        }
        
        pagesFetched++;
      }
      
      renderNotifications();
      updateLoadMoreState();
    } catch (error) {
      console.error('Load more notifications failed:', error);
      alert('Failed to load more notifications. Please try again.');
    } finally {
      notificationPagination.isLoading = false;
      hideLoadingState();
      // Re-enable button after loading completes (updateLoadMoreState will handle correct state)
      updateLoadMoreState();
    }
  }

  function showLoadingState() {
    const loadMoreItem = document.getElementById('notification-load-more-item');
    const loadingItem = document.getElementById('notification-loading-item');
    const noMoreItem = document.getElementById('notification-no-more-item');

    // Immediately hide all items
    loadMoreItem.hidden = true;
    noMoreItem.hidden = true;
    
    // Show loading item
    loadingItem.hidden = false;
  }

  function hideLoadingState() {
    const loadingItem = document.getElementById('notification-loading-item');

    // Smooth transition: fade out Loading
    loadingItem.style.opacity = '0';
    loadingItem.style.transform = 'translateY(-8px)';
    loadingItem.style.transition = 'opacity 0.3s ease, transform 0.3s ease';

    setTimeout(() => {
      loadingItem.hidden = true;
      loadingItem.style.opacity = '1';
      loadingItem.style.transform = 'translateY(0)';
      loadingItem.style.transition = 'none';
    }, 300);
  }

  function updateLoadMoreState() {
    const loadMoreItem = document.getElementById('notification-load-more-item');
    const noMoreItem = document.getElementById('notification-no-more-item');
    const loadMoreBtn = document.getElementById('load-more-btn');

    // Immediately hide all items first
    loadMoreItem.hidden = true;
    loadMoreItem.style.opacity = '0';
    loadMoreItem.style.transform = 'translateY(8px)';
    loadMoreItem.style.transition = 'none';

    noMoreItem.hidden = true;
    noMoreItem.style.opacity = '0';
    noMoreItem.style.transform = 'translateY(8px)';
    noMoreItem.style.transition = 'none';

    const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
    let filtered = currentNotifications;
    if (activeFilter === 'unresolved') {
      filtered = currentNotifications.filter(n => n.status === 'failed' && !acknowledgedNotifications.has(`${n.job_name}_${n.start_time}`));
    }

    if (notificationPagination.hasMore) {
      // Show Load More button
      loadMoreItem.hidden = false;
      loadMoreItem.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      loadMoreItem.style.opacity = '0';
      loadMoreItem.style.transform = 'translateY(8px)';

      // Trigger reflow and start transition
      void loadMoreItem.offsetWidth;
      loadMoreItem.style.opacity = '1';
      loadMoreItem.style.transform = 'translateY(0)';

      // Disable button if there are no notifications to load
      const isLoading = notificationPagination.isLoading;
      const hasNoNotifications = filtered.length === 0;
      loadMoreBtn.disabled = isLoading || hasNoNotifications;
    } else {
      // Show "No more notifications"
      noMoreItem.hidden = false;
      noMoreItem.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      noMoreItem.style.opacity = '0';
      noMoreItem.style.transform = 'translateY(8px)';

      // Trigger reflow and start transition
      void noMoreItem.offsetWidth;
      noMoreItem.style.opacity = '1';
      noMoreItem.style.transform = 'translateY(0)';
    }
  }

  function resetPagination() {
    notificationPagination.offset = 0;
    notificationPagination.hasMore = true;
    notificationPagination.isLoading = false;
  }

  function renderNotifications() {
    const listDiv = document.getElementById('notification-list');
    const paginationFooter = document.getElementById('notification-pagination-footer');
    const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;

    let filtered = currentNotifications;
    if (activeFilter === 'unresolved') {
      filtered = currentNotifications.filter(n => n.status === 'failed' && !acknowledgedNotifications.has(`${n.job_name}_${n.start_time}`));
    }

    // Sort by most recent first
    filtered.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));

    // Clear all content except the pagination footer
    const existingItems = listDiv.querySelectorAll('.notification-item, .no-notifications-message');
    existingItems.forEach(item => item.remove());

    // Create notification items
    let html = '';
    filtered.forEach(notification => {
      const id = `${notification.job_name}_${notification.start_time}`;
      const isAcknowledged = acknowledgedNotifications.has(id);
      const status = getNotificationStatus(notification.status, isAcknowledged);
      const outcome = getNotificationOutcome(notification.status);
      const timeStr = formatNotificationTime(notification.start_time);

      html += `
        <div class="notification-item ${status.className}" onclick="showJobDetails('${id}')">
          <div class="notification-content">
            <div class="notification-status-icon" style="${status.iconStyle}"></div>
            <div class="notification-details">
              <div class="notification-title">${formatJobName(notification.job_name)}</div>
              <div class="notification-outcome">${outcome}</div>
              <div class="notification-time">${timeStr}</div>
            </div>
          </div>
        </div>
      `;
    });

    if (filtered.length === 0) {
      html = '<div class="no-notifications-message" style="text-align: center; padding: 2rem; color: #6b7280;">No notifications found.</div>';
    }

    // Insert notifications before the pagination footer
    if (html) {
      paginationFooter.insertAdjacentHTML('beforebegin', html);
    }

    // Update Load More state
    updateLoadMoreState();
  }

  function getNotificationStatus(status, isAcknowledged) {
    if (status === 'failed') {
      if (isAcknowledged) {
        return {
          className: 'acknowledged-error',
          iconStyle: 'display: none;'
        };
      } else {
        return {
          className: 'unresolved-error',
          iconStyle: 'background: #ef4444; border-radius: 50%;'
        };
      }
    } else {
      return {
        className: 'success',
        iconStyle: ''
      };
    }
  }

  function getNotificationOutcome(status) {
    switch (status) {
      case 'success': return 'Success';
      case 'failed': return 'Failed';
      case 'running': return 'Running';
      case 'skipped': return 'Skipped';
      default: return 'Unknown';
    }
  }

  function acknowledgeNotification(id) {
    acknowledgedNotifications.add(id);
    localStorage.setItem('acknowledged_notifications', JSON.stringify([...acknowledgedNotifications]));
    renderNotifications();
    updateBellDot();
  }

  function updateBellDot() {
    const hasUnresolved = currentNotifications.some(n =>
      n.status === 'failed' && !acknowledgedNotifications.has(`${n.job_name}_${n.start_time}`)
    );
    document.getElementById('notification-dot').style.display = hasUnresolved ? 'block' : 'none';
  }

  function generateJsonOutput(jsonOutput) {
    let html = '<div class="activity-json">';
    if (jsonOutput.date) {
      html += `<div class="json-field"><strong>Date:</strong> ${jsonOutput.date}</div>`;
    }
    if (jsonOutput.selector) {
      html += `<div class="json-field"><strong>Selector:</strong> ${jsonOutput.selector}</div>`;
    }
    if (jsonOutput.weekday) {
      html += `<div class="json-field"><strong>Weekday:</strong> ${jsonOutput.weekday}</div>`;
    }
    if (jsonOutput.content_source) {
      html += `<div class="json-field"><strong>Source:</strong> ${jsonOutput.content_source}</div>`;
    }
    if (jsonOutput.resend) {
      html += `<div class="json-field"><strong>Resend:</strong> Yes</div>`;
    }
    html += '</div>';
    return html;
  }

  function formatJobName(jobName) {
    const nameMap = {
      'daily_email_send': 'Daily Email Send',
      'weekly_schedule_summary': 'Weekly Schedule Summary'
    };
    return nameMap[jobName] || jobName;
  }

  function formatNotificationTime(isoString) {
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} min ago`;

    if (diffHours < 24) {
      // Check if today
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const dateDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      if (dateDay.getTime() === today.getTime()) {
        return `Today at ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
      }
    }

    if (diffHours >= 24 && diffHours < 48) {
      // Yesterday
      return `Yesterday at ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
    }

    if (diffDays >= 2) {
      // Older than yesterday
      return `${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} at ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
    }

    return `${diffHours}h ago`; // fallback
  }

  async function showJobDetails(executionId) {
    try {
      const response = await fetch(`/api/jobs/logs/${executionId}`);
      if (!response.ok) {
        throw new Error('Failed to load job details');
      }
      const data = await response.json();
      const execution = data.execution;

      // Format the start time nicely
      const startDate = new Date(execution.start_time);
      const formattedStartTime = startDate.toLocaleString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });

      // Format the end time nicely if available
      const formattedEndTime = execution.end_time ? new Date(execution.end_time).toLocaleString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      }) : null;

      // Get status and outcome
      const outcome = getNotificationOutcome(execution.status);
      const statusClass = execution.status === 'failed' ? 'status-error' :
                         execution.status === 'success' ? 'status-success' : 'status-info';

      // Create job details modal
      const modal = document.createElement('div');
      modal.className = 'job-details-modal-overlay overlay';
      modal.innerHTML = `
        <div class="job-details-modal">
          <div class="job-details-header">
            <h3>Job Details</h3>
            <button class="job-details-close" onclick="event.stopPropagation(); this.closest('.job-details-modal-overlay').remove()">×</button>
          </div>
          <div class="job-details-content">
            <div class="job-info-section">
              <div class="job-info-row">
                <span class="job-info-label">Job:</span>
                <span class="job-info-value">${formatJobName(execution.job_name)}</span>
              </div>
              <div class="job-info-row">
                <span class="job-info-label">Started:</span>
                <span class="job-info-value">${formattedStartTime}</span>
              </div>
              ${execution.end_time ? `
              <div class="job-info-row">
                <span class="job-info-label">Ended:</span>
                <span class="job-info-value">${formattedEndTime}</span>
              </div>
              ` : ''}
              <div class="job-info-row">
                <span class="job-info-label">Status:</span>
                <span class="job-info-value status-indicator ${statusClass}">${outcome}</span>
              </div>
              ${execution.end_time ? `
              <div class="job-info-row">
                <span class="job-info-label">Duration:</span>
                <span class="job-info-value">${formatDuration(execution.start_time, execution.end_time)}</span>
              </div>
              ` : ''}
            </div>
            <div class="job-actions-section">
              <button class="show-log-btn" onclick="toggleLogSection(this)">
                Show Run Log
              </button>
            </div>
            <div class="log-section" style="display: none;">
              <div class="log-header">
                <h4>Technical Details</h4>
                <button class="hide-log-btn" onclick="toggleLogSection(this)">
                  Hide Run Log
                </button>
              </div>
              <div class="log-content">
                <pre class="log-text">${data.logs.map(line => escapeHtml(line)).join('\n')}</pre>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Close on backdrop click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });

      // Acknowledge the notification when viewing details
      acknowledgeNotification(executionId);

    } catch (error) {
      console.error('Failed to load job details:', error);
      alert('Failed to load job details. Check console for details.');
    }
  }

  function toggleLogSection(button) {
    const modal = button.closest('.job-details-modal');
    const logSection = modal.querySelector('.log-section');
    const showBtn = modal.querySelector('.show-log-btn');
    const hideBtn = modal.querySelector('.hide-log-btn');

    if (logSection.style.display === 'none') {
      logSection.style.display = 'block';
      showBtn.style.display = 'none';
      hideBtn.style.display = 'inline-block';
    } else {
      logSection.style.display = 'none';
      showBtn.style.display = 'inline-block';
      hideBtn.style.display = 'none';
    }
  }

  function formatDuration(startTime, endTime) {
    const start = new Date(startTime);
    const end = new Date(endTime);
    const diffMs = end - start;
    const diffSeconds = Math.floor(diffMs / 1000);

    if (diffSeconds < 60) return `${diffSeconds} seconds`;
    const diffMinutes = Math.floor(diffSeconds / 60);
    if (diffMinutes < 60) return `${diffMinutes} minutes`;
    const diffHours = Math.floor(diffMinutes / 60);
    return `${diffHours} hours`;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
<script src="/static/calendar.js" defer></script>
{% endblock %}
