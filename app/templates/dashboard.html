{% extends "base.html" %}
{% block title %}Calendar · Daily Manna Email{% endblock %}
{% block header_right %}
  <button type="button" id="notification-bell" class="bell-icon" aria-label="Notifications">
    <svg viewBox="0 0 24 24" fill="currentColor" class="bell-svg">
      <path d="M12 2C10.896 2 10 2.896 10 4v1.07C7.835 5.732 6 7.814 6 10v6H4v2h16v-2h-2v-6c0-2.186-1.835-4.268-4-4.93V4c0-1.104-.896-2-2-2zM12 22c1.104 0 2-.896 2-2H10c0 1.104.896 2 2 2z"/>
    </svg>
    <span id="notification-dot" class="notification-dot" style="display: none;"></span>
  </button>
{% endblock %}
{% block content %}
<section id="flash-messages" class="flash-messages">
  {% if message %}
    <div class="flash success" data-type="success">{{ message }}</div>
  {% endif %}
  {% if error %}
    <div class="flash error" data-type="error">{{ error }}</div>
    {% if request.query_params.get('action') == 'manage_permissions' %}
      <div class="flash info" data-type="info">
        <a href="https://myaccount.google.com/permissions" target="_blank" class="manage-permissions-link">
          Manage Google Account Permissions →
        </a>
      </div>
    {% endif %}
  {% endif %}
</section>
<section class="summary">
  <p>Schedule file: <code>{{ schedule_path }}</code></p>
</section>
<section id="oauth-section" class="oauth-status">
  <h3>Email Authorization</h3>
  <div id="oauth-status">
    <p class="oauth-loading">Checking authorization status...</p>
  </div>
</section>

<section class="calendar-shell">
  <header class="calendar-toolbar">
    <div class="calendar-toolbar-info">
      <h2 id="month-year" class="calendar-range">Loading...</h2>
      <p class="calendar-help-text">Shift-click to multi-select, drag selections to move, or press <kbd>Shift</kbd>+<kbd>D</kbd> to jump to a specific date.</p>
      <div class="calendar-toolbar-batch" id="batch-toolbar" hidden>
        <button type="button" id="batch-edit-btn" class="primary">Edit All</button>
        <span id="selection-count"></span>
      </div>
    </div>
    <div class="calendar-toolbar-controls">
      <form method="post" action="/logout" style="display: inline;">
        <button type="submit" class="logout-btn" aria-label="Logout">Logout</button>
      </form>
      <button type="button" id="prev-month" aria-label="Previous month">‹</button>
      <button type="button" id="today-month">Today</button>
      <button type="button" id="next-month" aria-label="Next month">›</button>
    </div>
  </header>
  <div id="calendar-scroll" class="calendar-scroll" aria-live="polite"></div>
</section>
<div id="calendar-popover" class="calendar-popover" hidden role="dialog" aria-modal="true" aria-labelledby="popover-date-label">
  <form id="popover-form">
    <header class="popover-header">
      <div>
        <p class="popover-date" id="popover-date-label"></p>
        <p class="popover-meta" id="popover-sent-meta"></p>
      </div>
      <button type="button" class="popover-close" data-action="close" aria-label="Close popover">×</button>
    </header>
    <input type="hidden" name="date" id="popover-date" value="">
    <div class="popover-field">
      <label for="popover-selector">Selector</label>
      <input type="text" id="popover-selector" name="selector" placeholder="e.g. 2-1-3" required>
    </div>
    <div class="popover-field">
      <label for="popover-status">Status</label>
      <select id="popover-status" name="status">
        <option value="">-- Select status --</option>
        <option value="pending">Pending</option>
        <option value="sent">Sent</option>
        <option value="skipped">Skipped</option>
      </select>
    </div>
    <div class="popover-field">
      <label for="popover-notes">Notes</label>
      <textarea id="popover-notes" name="notes" rows="3" placeholder="Add context"></textarea>
    </div>
    <div class="popover-field">
      <label for="popover-override">Override descriptor</label>
      <input type="text" id="popover-override" name="override" placeholder="Optional override">
    </div>
    <div class="popover-actions">
      <div class="popover-action-group">
        <button type="submit" class="primary">Save</button>
        <button type="button" data-action="mark-sent">Mark sent</button>
        <button type="button" data-action="mark-skipped">Mark skipped</button>
        <button type="button" data-action="delete" class="danger">Delete</button>
      </div>
      <button type="button" data-action="close">Cancel</button>
    </div>
  </form>
</div>
<div id="date-adjust-overlay" class="calendar-move-overlay" hidden>
  <form id="date-adjust-form" class="calendar-move-card">
    <p>Move selected events to:</p>
    <input type="date" id="date-adjust-input" required>
    <div class="overlay-actions">
      <button type="submit" class="primary">Apply</button>
      <button type="button" data-action="cancel">Cancel</button>
    </div>
  </form>
</div>
<div id="batch-edit-overlay" class="calendar-edit-overlay" hidden>
  <form id="batch-edit-form" class="calendar-edit-card">
    <p>Edit selected events:</p>
    <div class="batch-edit-field">
      <label for="batch-selector">Selector</label>
      <input type="text" id="batch-selector" name="selector" placeholder="e.g. 2-1-3" aria-describedby="batch-selector-help batch-range-hint">
      <small id="batch-selector-help" class="form-text text-muted">
        <!-- Dynamic help text from backend -->
      </small>
      <small id="batch-range-hint" class="form-text text-info" hidden>
        <!-- Dynamic range hint from backend -->
      </small>
      <small>Leave blank to keep existing values</small>
    </div>
    <div class="batch-edit-field">
      <label for="batch-status">Status</label>
      <select id="batch-status" name="status">
        <option value="">-- Keep existing --</option>
        <option value="pending">Pending</option>
        <option value="sent">Sent</option>
        <option value="skipped">Skipped</option>
      </select>
    </div>
    <div class="batch-edit-field">
      <label for="batch-notes">Notes</label>
      <textarea id="batch-notes" name="notes" rows="3" placeholder="Add context"></textarea>
      <small>Leave blank to keep existing values</small>
    </div>
    <div class="batch-edit-field">
      <label for="batch-override">Override descriptor</label>
      <input type="text" id="batch-override" name="override" placeholder="Optional override">
      <small>Leave blank to keep existing values</small>
    </div>
    <div class="overlay-actions">
      <div class="overlay-action-group">
        <button type="submit" class="primary">Apply to All</button>
        <button type="button" data-action="batch-delete" class="danger">Delete Events</button>
      </div>
      <button type="button" data-action="cancel">Cancel</button>
    </div>
  </form>
</div>
<div id="notification-overlay" class="notification-overlay" hidden>
  <div class="notification-center">
    <div class="notification-header">
      <h3>Notifications</h3>
      <button class="notification-close" aria-label="Close">×</button>
    </div>
    <div class="notification-filters">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="unresolved">Unresolved</button>
    </div>
    <div id="notification-list" class="notification-list">
      <!-- notifications will be loaded here -->
    </div>
  </div>
</div>
<script>
  window.CalendarConfig = {
    schedulePath: "{{ schedule_path }}",
    message: null,
    error: null
  };

  // OAuth status management
  async function checkOAuthStatus() {
    const statusDiv = document.getElementById('oauth-status');
    try {
      const response = await fetch('/oauth/status');
      if (!response.ok) {
        throw new Error('Failed to check OAuth status');
      }
      const data = await response.json();

      // Debug logging for OAuth status (remove in production)
      // console.log('OAuth status response:', data);

      if (data.authorized && data.scope_status === 'exact') {
        statusDiv.innerHTML = `
          <p class="oauth-authorized">
            ✓ You have authorized the app to use your email
          </p>
        `;
      } else if (data.authorized && data.scope_status === 'over-authorized') {
        const extraScopesDescriptions = data.extra_scopes_descriptions || [];
        statusDiv.innerHTML = `
          <div class="oauth-over-authorized">
            <p>✓ Authorized with additional permissions</p>
            <p style="font-size: 0.9em; color: #6b7280; margin: 0.5rem 0;">
              Additional permissions: ${extraScopesDescriptions.join(', ')}
            </p>
            <p style="font-size: 0.9em; color: #6b7280; margin: 0.5rem 0 1rem;">
              To use only required permissions, revoke and re-authorize.
            </p>
            <a href="https://myaccount.google.com/permissions" target="_blank" class="oauth-manage-btn">
              Manage Google Account Permissions
            </a>
          </div>
        `;
      } else if (data.scope_status === 'under-authorized' || (data.missing_scopes && data.missing_scopes.length > 0)) {
        // Token exists but missing required scopes
        const missingScopesDescriptions = data.missing_scopes_descriptions || [];
        const missingList = missingScopesDescriptions.length > 0 ? ` (${missingScopesDescriptions.join(', ')})` : '';
        statusDiv.innerHTML = `
          <div class="oauth-under-authorized">
            <p>❌ Email authorization incomplete - missing required permissions${missingList}</p>
            <a href="/oauth/start" class="oauth-grant-btn">Grant Required Access</a>
          </div>
        `;
      } else {
        // No token at all or other unauthorized states
        statusDiv.innerHTML = `
          <div class="oauth-unauthorized">
            <p>Email authorization required to send emails</p>
            <a href="/oauth/start" class="oauth-grant-btn">Grant Email Access</a>
          </div>
        `;
      }
    } catch (error) {
      console.error('OAuth status check failed:', error);
      statusDiv.innerHTML = `
        <div class="oauth-unauthorized">
          <p>Unable to check authorization status</p>
          <a href="/oauth/start" class="oauth-grant-btn">Grant Email Access</a>
        </div>
      `;
    }
  }

  // Notification system state
  let currentNotifications = [];
  let acknowledgedNotifications = new Set(JSON.parse(localStorage.getItem('acknowledged_notifications') || '[]'));

  // Check OAuth status when page loads
  document.addEventListener('DOMContentLoaded', function() {
    checkOAuthStatus();
    loadNotifications();

    // Bell icon click
    document.getElementById('notification-bell').addEventListener('click', toggleNotificationOverlay);

    // Close overlay
    document.querySelector('.notification-close').addEventListener('click', hideNotificationOverlay);

    // Click outside to close
    document.addEventListener('click', function(e) {
      const overlay = document.getElementById('notification-overlay');
      const bell = document.getElementById('notification-bell');

      if (!overlay.hidden) {
        const center = overlay.querySelector('.notification-center');
        const isClickInsideOverlay = center.contains(e.target) || bell.contains(e.target);
        const isClickInsideModal = document.querySelector('.job-details-modal-overlay')?.contains(e.target);

        if (!isClickInsideOverlay && !isClickInsideModal) {
          hideNotificationOverlay();
        }
      }
    });

    // Filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        renderNotifications();
      });
    });
  });

  function showNotificationOverlay() {
    const overlay = document.getElementById('notification-overlay');
    const bell = document.getElementById('notification-bell');
    const rect = bell.getBoundingClientRect();

    // Show off-screen to measure width
    overlay.style.top = '-1000px';
    overlay.hidden = false;

    const center = overlay.querySelector('.notification-center');
    const panelWidth = center.offsetWidth;

    // Now position correctly under bell's bottom-right
    overlay.style.top = (rect.bottom + 8) + 'px';
    overlay.style.left = (rect.right - panelWidth) + 'px';
  }

  function toggleNotificationOverlay() {
    const overlay = document.getElementById('notification-overlay');
    if (overlay.hidden) {
      showNotificationOverlay();
    } else {
      hideNotificationOverlay();
    }
  }

  function hideNotificationOverlay() {
    document.getElementById('notification-overlay').hidden = true;
  }

  // Notification management
  async function loadNotifications() {
    try {
      const response = await fetch('/api/jobs/recent?limit=20');
      if (!response.ok) {
        throw new Error('Failed to load notifications');
      }
      const data = await response.json();
      currentNotifications = data.executions || [];
      renderNotifications();
      updateBellDot();
    } catch (error) {
      console.error('Notification load failed:', error);
    }
  }

  function renderNotifications() {
    const listDiv = document.getElementById('notification-list');
    const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;

    let filtered = currentNotifications;
    if (activeFilter === 'unresolved') {
      filtered = currentNotifications.filter(n => n.status === 'failed' && !acknowledgedNotifications.has(`${n.job_name}_${n.start_time}`));
    }

    // Sort by most recent first
    filtered.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));

    let html = '';
    filtered.forEach(notification => {
      const id = `${notification.job_name}_${notification.start_time}`;
      const isAcknowledged = acknowledgedNotifications.has(id);
      const status = getNotificationStatus(notification.status, isAcknowledged);
      const outcome = getNotificationOutcome(notification.status);
      const timeStr = formatNotificationTime(notification.start_time);

      html += `
        <div class="notification-item ${status.className}" onclick="showJobDetails('${id}')">
          <div class="notification-content">
            <div class="notification-status-icon" style="${status.iconStyle}"></div>
            <div class="notification-details">
              <div class="notification-title">${formatJobName(notification.job_name)}</div>
              <div class="notification-outcome">${outcome}</div>
              <div class="notification-time">${timeStr}</div>
            </div>
          </div>
        </div>
      `;
    });

    if (filtered.length === 0) {
      html = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No notifications found.</div>';
    }

    listDiv.innerHTML = html;
  }

  function getNotificationStatus(status, isAcknowledged) {
    if (status === 'failed') {
      if (isAcknowledged) {
        return {
          className: 'acknowledged-error',
          iconStyle: 'display: none;'
        };
      } else {
        return {
          className: 'unresolved-error',
          iconStyle: 'background: #ef4444; border-radius: 50%;'
        };
      }
    } else {
      return {
        className: 'success',
        iconStyle: ''
      };
    }
  }

  function getNotificationOutcome(status) {
    switch (status) {
      case 'success': return 'Success';
      case 'failed': return 'Failed';
      case 'running': return 'Running';
      case 'skipped': return 'Skipped';
      default: return 'Unknown';
    }
  }

  function acknowledgeNotification(id) {
    acknowledgedNotifications.add(id);
    localStorage.setItem('acknowledged_notifications', JSON.stringify([...acknowledgedNotifications]));
    renderNotifications();
    updateBellDot();
  }

  function updateBellDot() {
    const hasUnresolved = currentNotifications.some(n =>
      n.status === 'failed' && !acknowledgedNotifications.has(`${n.job_name}_${n.start_time}`)
    );
    document.getElementById('notification-dot').style.display = hasUnresolved ? 'block' : 'none';
  }

  function generateJsonOutput(jsonOutput) {
    let html = '<div class="activity-json">';
    if (jsonOutput.date) {
      html += `<div class="json-field"><strong>Date:</strong> ${jsonOutput.date}</div>`;
    }
    if (jsonOutput.selector) {
      html += `<div class="json-field"><strong>Selector:</strong> ${jsonOutput.selector}</div>`;
    }
    if (jsonOutput.weekday) {
      html += `<div class="json-field"><strong>Weekday:</strong> ${jsonOutput.weekday}</div>`;
    }
    if (jsonOutput.content_source) {
      html += `<div class="json-field"><strong>Source:</strong> ${jsonOutput.content_source}</div>`;
    }
    if (jsonOutput.resend) {
      html += `<div class="json-field"><strong>Resend:</strong> Yes</div>`;
    }
    html += '</div>';
    return html;
  }

  function formatJobName(jobName) {
    const nameMap = {
      'daily_email_send': 'Daily Email Send',
      'weekly_schedule_summary': 'Weekly Schedule Summary'
    };
    return nameMap[jobName] || jobName;
  }

  function formatNotificationTime(isoString) {
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} min ago`;

    if (diffHours < 24) {
      // Check if today
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const dateDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      if (dateDay.getTime() === today.getTime()) {
        return `Today at ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
      }
    }

    if (diffHours >= 24 && diffHours < 48) {
      // Yesterday
      return `Yesterday at ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
    }

    if (diffDays >= 2) {
      // Older than yesterday
      return `${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} at ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
    }

    return `${diffHours}h ago`; // fallback
  }

  async function showJobDetails(executionId) {
    try {
      const response = await fetch(`/api/jobs/logs/${executionId}`);
      if (!response.ok) {
        throw new Error('Failed to load job details');
      }
      const data = await response.json();
      const execution = data.execution;

      // Format the start time nicely
      const startDate = new Date(execution.start_time);
      const formattedStartTime = startDate.toLocaleString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });

      // Format the end time nicely if available
      const formattedEndTime = execution.end_time ? new Date(execution.end_time).toLocaleString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      }) : null;

      // Get status and outcome
      const outcome = getNotificationOutcome(execution.status);
      const statusClass = execution.status === 'failed' ? 'status-error' :
                         execution.status === 'success' ? 'status-success' : 'status-info';

      // Create job details modal
      const modal = document.createElement('div');
      modal.className = 'job-details-modal-overlay';
      modal.innerHTML = `
        <div class="job-details-modal">
          <div class="job-details-header">
            <h3>Job Details</h3>
            <button class="job-details-close" onclick="event.stopPropagation(); this.closest('.job-details-modal-overlay').remove()">×</button>
          </div>
          <div class="job-details-content">
            <div class="job-info-section">
              <div class="job-info-row">
                <span class="job-info-label">Job:</span>
                <span class="job-info-value">${formatJobName(execution.job_name)}</span>
              </div>
              <div class="job-info-row">
                <span class="job-info-label">Started:</span>
                <span class="job-info-value">${formattedStartTime}</span>
              </div>
              ${execution.end_time ? `
              <div class="job-info-row">
                <span class="job-info-label">Ended:</span>
                <span class="job-info-value">${formattedEndTime}</span>
              </div>
              ` : ''}
              <div class="job-info-row">
                <span class="job-info-label">Status:</span>
                <span class="job-info-value status-indicator ${statusClass}">${outcome}</span>
              </div>
              ${execution.end_time ? `
              <div class="job-info-row">
                <span class="job-info-label">Duration:</span>
                <span class="job-info-value">${formatDuration(execution.start_time, execution.end_time)}</span>
              </div>
              ` : ''}
            </div>
            <div class="job-actions-section">
              <button class="show-log-btn" onclick="toggleLogSection(this)">
                Show Run Log
              </button>
            </div>
            <div class="log-section" style="display: none;">
              <div class="log-header">
                <h4>Technical Details</h4>
                <button class="hide-log-btn" onclick="toggleLogSection(this)">
                  Hide Run Log
                </button>
              </div>
              <div class="log-content">
                <pre class="log-text">${data.logs.map(line => escapeHtml(line)).join('\n')}</pre>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Close on backdrop click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });

      // Acknowledge the notification when viewing details
      acknowledgeNotification(executionId);

    } catch (error) {
      console.error('Failed to load job details:', error);
      alert('Failed to load job details. Check console for details.');
    }
  }

  function toggleLogSection(button) {
    const modal = button.closest('.job-details-modal');
    const logSection = modal.querySelector('.log-section');
    const showBtn = modal.querySelector('.show-log-btn');
    const hideBtn = modal.querySelector('.hide-log-btn');

    if (logSection.style.display === 'none') {
      logSection.style.display = 'block';
      showBtn.style.display = 'none';
      hideBtn.style.display = 'inline-block';
    } else {
      logSection.style.display = 'none';
      showBtn.style.display = 'inline-block';
      hideBtn.style.display = 'none';
    }
  }

  function formatDuration(startTime, endTime) {
    const start = new Date(startTime);
    const end = new Date(endTime);
    const diffMs = end - start;
    const diffSeconds = Math.floor(diffMs / 1000);

    if (diffSeconds < 60) return `${diffSeconds} seconds`;
    const diffMinutes = Math.floor(diffSeconds / 60);
    if (diffMinutes < 60) return `${diffMinutes} minutes`;
    const diffHours = Math.floor(diffMinutes / 60);
    return `${diffHours} hours`;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
<script src="/static/calendar.js" defer></script>
{% endblock %}
