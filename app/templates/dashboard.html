{% extends "base.html" %}
{% block title %}Calendar · Daily Manna Email{% endblock %}
{% block content %}
<section id="flash-messages" class="flash-messages">
  {% if message %}
    <div class="flash success" data-type="success">{{ message }}</div>
  {% endif %}
  {% if error %}
    <div class="flash error" data-type="error">{{ error }}</div>
    {% if request.query_params.get('action') == 'manage_permissions' %}
      <div class="flash info" data-type="info">
        <a href="https://myaccount.google.com/permissions" target="_blank" class="manage-permissions-link">
          Manage Google Account Permissions →
        </a>
      </div>
    {% endif %}
  {% endif %}
</section>
<section class="summary">
  <p>Schedule file: <code>{{ schedule_path }}</code></p>
</section>
<section id="oauth-section" class="oauth-status">
  <h3>Email Authorization</h3>
  <div id="oauth-status">
    <p class="oauth-loading">Checking authorization status...</p>
  </div>
</section>
<section class="calendar-shell">
  <header class="calendar-toolbar">
    <div class="calendar-toolbar-info">
      <h2 id="month-year" class="calendar-range">Loading...</h2>
      <p class="calendar-help-text">Shift-click to multi-select, drag selections to move, or press <kbd>Shift</kbd>+<kbd>D</kbd> to jump to a specific date.</p>
      <div class="calendar-toolbar-batch" id="batch-toolbar" hidden>
        <button type="button" id="batch-edit-btn" class="primary">Edit All</button>
        <span id="selection-count"></span>
      </div>
    </div>
    <div class="calendar-toolbar-controls">
      <form method="post" action="/logout" style="display: inline;">
        <button type="submit" class="logout-btn" aria-label="Logout">Logout</button>
      </form>
      <button type="button" id="prev-month" aria-label="Previous month">‹</button>
      <button type="button" id="today-month">Today</button>
      <button type="button" id="next-month" aria-label="Next month">›</button>
    </div>
  </header>
  <div id="calendar-scroll" class="calendar-scroll" aria-live="polite"></div>
</section>
<div id="calendar-popover" class="calendar-popover" hidden role="dialog" aria-modal="true" aria-labelledby="popover-date-label">
  <form id="popover-form">
    <header class="popover-header">
      <div>
        <p class="popover-date" id="popover-date-label"></p>
        <p class="popover-meta" id="popover-sent-meta"></p>
      </div>
      <button type="button" class="popover-close" data-action="close" aria-label="Close popover">×</button>
    </header>
    <input type="hidden" name="date" id="popover-date" value="">
    <div class="popover-field">
      <label for="popover-selector">Selector</label>
      <input type="text" id="popover-selector" name="selector" placeholder="e.g. 2-1-3" required>
    </div>
    <div class="popover-field">
      <label for="popover-status">Status</label>
      <select id="popover-status" name="status">
        <option value="">-- Select status --</option>
        <option value="pending">Pending</option>
        <option value="sent">Sent</option>
        <option value="skipped">Skipped</option>
      </select>
    </div>
    <div class="popover-field">
      <label for="popover-notes">Notes</label>
      <textarea id="popover-notes" name="notes" rows="3" placeholder="Add context"></textarea>
    </div>
    <div class="popover-field">
      <label for="popover-override">Override descriptor</label>
      <input type="text" id="popover-override" name="override" placeholder="Optional override">
    </div>
    <div class="popover-actions">
      <div class="popover-action-group">
        <button type="submit" class="primary">Save</button>
        <button type="button" data-action="mark-sent">Mark sent</button>
        <button type="button" data-action="mark-skipped">Mark skipped</button>
        <button type="button" data-action="delete" class="danger">Delete</button>
      </div>
      <button type="button" data-action="close">Cancel</button>
    </div>
  </form>
</div>
<div id="date-adjust-overlay" class="calendar-move-overlay" hidden>
  <form id="date-adjust-form" class="calendar-move-card">
    <p>Move selected events to:</p>
    <input type="date" id="date-adjust-input" required>
    <div class="overlay-actions">
      <button type="submit" class="primary">Apply</button>
      <button type="button" data-action="cancel">Cancel</button>
    </div>
  </form>
</div>
<div id="batch-edit-overlay" class="calendar-edit-overlay" hidden>
  <form id="batch-edit-form" class="calendar-edit-card">
    <p>Edit selected events:</p>
    <div class="batch-edit-field">
      <label for="batch-selector">Selector</label>
      <input type="text" id="batch-selector" name="selector" placeholder="e.g. 2-1-3" aria-describedby="batch-selector-help batch-range-hint">
      <small id="batch-selector-help" class="form-text text-muted">
        <!-- Dynamic help text from backend -->
      </small>
      <small id="batch-range-hint" class="form-text text-info" hidden>
        <!-- Dynamic range hint from backend -->
      </small>
      <small>Leave blank to keep existing values</small>
    </div>
    <div class="batch-edit-field">
      <label for="batch-status">Status</label>
      <select id="batch-status" name="status">
        <option value="">-- Keep existing --</option>
        <option value="pending">Pending</option>
        <option value="sent">Sent</option>
        <option value="skipped">Skipped</option>
      </select>
    </div>
    <div class="batch-edit-field">
      <label for="batch-notes">Notes</label>
      <textarea id="batch-notes" name="notes" rows="3" placeholder="Add context"></textarea>
      <small>Leave blank to keep existing values</small>
    </div>
    <div class="batch-edit-field">
      <label for="batch-override">Override descriptor</label>
      <input type="text" id="batch-override" name="override" placeholder="Optional override">
      <small>Leave blank to keep existing values</small>
    </div>
    <div class="overlay-actions">
      <div class="overlay-action-group">
        <button type="submit" class="primary">Apply to All</button>
        <button type="button" data-action="batch-delete" class="danger">Delete Events</button>
      </div>
      <button type="button" data-action="cancel">Cancel</button>
    </div>
  </form>
</div>
<script>
  window.CalendarConfig = {
    schedulePath: "{{ schedule_path }}",
    message: null,
    error: null
  };

  // OAuth status management
  async function checkOAuthStatus() {
    const statusDiv = document.getElementById('oauth-status');
    try {
      const response = await fetch('/oauth/status');
      if (!response.ok) {
        throw new Error('Failed to check OAuth status');
      }
      const data = await response.json();

      // Debug logging for OAuth status (remove in production)
      // console.log('OAuth status response:', data);

      if (data.authorized && data.scope_status === 'exact') {
        statusDiv.innerHTML = `
          <p class="oauth-authorized">
            ✓ You have authorized the app to use your email
          </p>
          <p style="font-size: 0.9em; color: #6b7280; margin: 1rem 0 0;">
            Email sending and schedule reply features are available
          </p>
        `;
      } else if (data.authorized && data.scope_status === 'over-authorized') {
        const extraScopesDescriptions = data.extra_scopes_descriptions || [];
        statusDiv.innerHTML = `
          <div class="oauth-over-authorized">
            <p>✓ Authorized with additional permissions</p>
            <p style="font-size: 0.9em; color: #6b7280; margin: 1rem 0 0;">
              Email sending and schedule reply features are available
            </p>
            <p style="font-size: 0.9em; color: #6b7280; margin: 0.5rem 0;">
              Additional permissions: ${extraScopesDescriptions.join(', ')}
            </p>
            <p style="font-size: 0.9em; color: #6b7280; margin: 0.5rem 0 1rem;">
              To use only required permissions, revoke and re-authorize.
            </p>
            <a href="https://myaccount.google.com/permissions" target="_blank" class="oauth-manage-btn">
              Manage Google Account Permissions
            </a>
          </div>
        `;
      } else if (data.authorized && data.scope_status === 'partial') {
        // Partial permissions - show available and disabled features
        const availableFeatures = data.available_features || [];
        const disabledFeatures = data.disabled_features || [];
        const missingScopesDescriptions = data.missing_scopes_descriptions || [];

        let featuresHtml = '';
        if (availableFeatures.length > 0) {
          featuresHtml += `<p style="font-size: 0.9em; color: #059669; margin: 0.5rem 0;">✓ Available: ${availableFeatures.join(', ')}</p>`;
        }
        if (disabledFeatures.length > 0) {
          featuresHtml += `<p style="font-size: 0.9em; color: #dc2626; margin: 0.5rem 0;">✗ Disabled: ${disabledFeatures.join(', ')}</p>`;
        }
        if (missingScopesDescriptions.length > 0) {
          featuresHtml += `<p style="font-size: 0.9em; color: #6b7280; margin: 0.5rem 0;">Missing permissions: ${missingScopesDescriptions.join(', ')}</p>`;
        }

        statusDiv.innerHTML = `
          <div class="oauth-partial">
            <p>⚠️ Partial email authorization</p>
            ${featuresHtml}
            <p style="font-size: 0.9em; color: #6b7280; margin: 0.5rem 0 1rem;">
              Some features are disabled due to limited permissions. You can grant full access for all features.
            </p>
            <a href="/oauth/start" class="oauth-grant-btn">Grant Full Access</a>
            <a href="https://myaccount.google.com/permissions" target="_blank" class="oauth-manage-btn" style="margin-left: 0.5rem;">
              Manage Permissions
            </a>
          </div>
        `;
      } else {
        // No token at all or other unauthorized states
        statusDiv.innerHTML = `
          <div class="oauth-unauthorized">
            <p>Email authorization required to send emails</p>
            <a href="/oauth/start" class="oauth-grant-btn">Grant Email Access</a>
          </div>
        `;
      }
    } catch (error) {
      console.error('OAuth status check failed:', error);
      statusDiv.innerHTML = `
        <div class="oauth-unauthorized">
          <p>Unable to check authorization status</p>
          <a href="/oauth/start" class="oauth-grant-btn">Grant Email Access</a>
        </div>
      `;
    }
  }

  // Check OAuth status when page loads
  document.addEventListener('DOMContentLoaded', function() {
    checkOAuthStatus();
  });
</script>
<script src="/static/calendar.js" defer></script>
{% endblock %}
